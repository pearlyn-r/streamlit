Thanks for laying that out clearly. You want to:

1. Use two separate CTEs: one for today, one for yesterday


2. Join them to produce the pivoted, side-by-side comparison


3. Include rating and industry_flag from both dates (if needed)




---

‚úÖ Final SQL Query (Using Two CTEs: Today + Yesterday)

WITH today AS (
  SELECT
    name,
    id,
    product,
    SUM(contribution) AS contribution_today,
    CASE WHEN tier IN ('x', 'f') THEN 'a' ELSE 'b' END AS rating_today,
    CASE WHEN industry IN ('x', 'f') THEN 'a' ELSE 'b' END AS industry_today
  FROM your_table
  WHERE date = CURRENT_DATE
  GROUP BY name, id, product, tier, industry
),

yesterday AS (
  SELECT
    name,
    id,
    product,
    SUM(contribution) AS contribution_yesterday,
    CASE WHEN tier IN ('x', 'f') THEN 'a' ELSE 'b' END AS rating_yesterday,
    CASE WHEN industry IN ('x', 'f') THEN 'a' ELSE 'b' END AS industry_yesterday
  FROM your_table
  WHERE date = CURRENT_DATE - INTERVAL 1 DAY
  GROUP BY name, id, product, tier, industry
)

SELECT
  COALESCE(t.name, y.name) AS name,
  COALESCE(t.id, y.id) AS id,
  COALESCE(t.product, y.product) AS product,
  COALESCE(t.contribution_today, 0) AS date,
  COALESCE(y.contribution_yesterday, 0) AS previous_date,
  COALESCE(t.contribution_today, 0) - COALESCE(y.contribution_yesterday, 0) AS delta,
  ROUND(
    100.0 * (COALESCE(t.contribution_today, 0) - COALESCE(y.contribution_yesterday, 0)) / 
    NULLIF(COALESCE(y.contribution_yesterday, 0), 0),
    2
  ) AS percent_change,
  t.rating_today AS rating,
  t.industry_today AS industry
FROM today t
FULL OUTER JOIN yesterday y
  ON t.name = y.name AND t.id = y.id AND t.product = y.product;


---

üîç Notes

FULL OUTER JOIN ensures you get rows even if a product exists on only one of the two days.

If you only want rows present in both days, use INNER JOIN.

rating and industry are taken from today ‚Äî you can include both *_today and *_yesterday if you want to compare them explicitly.



---

üßæ Output Example

name	id	product	date	previous_date	delta	percent_change	rating	industry

Stock1	s1	prod a	50	40	10	25.00	b	d
Stock1	s1	prod b	50	50	0	0.00	b	d


Let me know if you want to:

Show mismatched rating between days

Filter to only changing stocks

Add a total row per stock


Happy to help expand this.

